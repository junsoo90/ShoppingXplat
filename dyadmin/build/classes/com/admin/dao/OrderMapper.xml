<?xml version="1.0" encoding="UTF-8" ?>  
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="OrderDao">
<!-- 
  <![CDATA[
            SELECT
                IDX,
                TITLE,
                CONTENTS,
                HIT_CNT,
                CREA_ID,
                IF(
                    DATE_FORMAT(CREA_DATE, '%Y%m%d') < DATE_FORMAT(now(),'%Y%m%d'),
                    DATE_FORMAT(CREA_DATE, '%Y.%m.%d'),
                    DATE_FORMAT(CREA_DATE, '%H:%i')
                ) as CREA_DATE
            FROM
                TB_BOARD
            WHERE
                IDX = #{ idx}
        ]]>

 -->
	<select id="orderList" resultType="OrderVO" parameterType="map">
		select
		purchaseSeq, to_char(orderdate, 'YYYY-MM-DD HH24:MI:SS') as time,
		CID, PSEQ,
		POPTION, OPTIONCNT, OPTIONPRICE, ORDERSTATE,
		PAYTYPE, PNAME, CARTCNT 
		
		from 
		
		(SELECT A.*, ROWNUM RNUM FROM
		(SELECT * FROM orderList  where orderState like '%'||#{keyWord}||'%'
			ORDER BY purchaseSeq desc)A)
		<![CDATA[
		 where RNUM >= #{start} AND RNUM <= #{end}		
		]]>
	</select>
	
	<select id="orderInfoCard" resultType="map" parameterType="OrderVO">
	 select orderList.*, 
                    paycard.cardName,
                    custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
                    pPhoto.filelocation, rownum rnum
                from orderList, paycard, custom, pPhoto
                
                where orderList.purchaseSeq = #{purchaseSeq}
                    and paycard.purchaseSeq = #{purchaseSeq}
                    and paycard.cId = custom.cId
                    and pPhoto.pSeq = orderList.pSeq
                    and pPhoto.savefilename = orderlist.savefilename
                    order by orderList.purchaseSeq desc
		<!-- select * from(
			select orderList.*, 
					paycard.cardName,
					custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
					pPhoto.filelocation, rownum rnum
				from orderList, paycard, custom, pPhoto
				
				where orderList.purchaseSeq = #{purchaseSeq}
					and paycard.purchaseSeq = #{purchaseSeq}
					and paycard.cId = custom.cId
					and pPhoto.pSeq = orderList.pSeq
					order by orderList.purchaseSeq desc
			)  where rnum = (select max(rnum) from (select * from(
			select orderList.*, 
					paycard.cardName,
					custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
					pPhoto.filelocation, rownum rnum
				from orderList, paycard, custom, pPhoto
				
				where orderList.purchaseSeq = #{purchaseSeq}
					and paycard.purchaseSeq = #{purchaseSeq}
					and paycard.cId = custom.cId
					and pPhoto.pSeq = orderList.pSeq
					order by orderList.purchaseSeq desc
			)))
			-->
	</select>
	
	<select id="orderInfoBank" resultType="map" parameterType="OrderVO">
	 select orderList.*, 
                    paybank.bankName,
                    custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
                    pPhoto.filelocation, rownum rnum
                from orderList, paybank, custom, pPhoto
                
                where orderList.purchaseSeq = #{purchaseSeq}
                    and paybank.purchaseSeq = #{purchaseSeq}
                    and paybank.cId = custom.cId
                    and pPhoto.pSeq = orderList.pSeq
                    and pPhoto.savefilename = orderlist.savefilename
                    order by orderList.purchaseSeq desc
		<!-- 
		select * from(
			select orderList.*, 
					paybank.bankName,
					custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
					pPhoto.filelocation, rownum rnum
				from orderList, paybank, custom, pPhoto
				
				where orderList.purchaseSeq = #{purchaseSeq}
					and paybank.purchaseSeq = #{purchaseSeq}
					and paybank.cId = custom.cId
					and pPhoto.pSeq = orderList.pSeq
					order by orderList.purchaseSeq desc
			)  where rnum = (select max(rnum) from (select * from(
			select orderList.*, 
					paybank.bankName,
					custom.cName, custom.cAddCode, custom.cAdd, custom.cAddDetail,
					pPhoto.filelocation, rownum rnum
				from orderList, paybank, custom, pPhoto
				
				where orderList.purchaseSeq = #{purchaseSeq}
					and paybank.purchaseSeq = #{purchaseSeq}
					and paybank.cId = custom.cId
					and pPhoto.pSeq = orderList.pSeq
					order by orderList.purchaseSeq desc
			)))
			-->
	</select>

	<select id="getPayType" resultType="String">
		select paytype from orderLIst where purchaseSeq = #{purchaseSeq}
	</select>
	
	<update id="updateOrderState">
		update orderList set orderState = #{orderState}
		where purchaseSeq = #{purchaseSeq}
	</update>
	
	<select id="getCount" resultType="Integer">
			SELECT COUNT(*) FROM orderList	
			 where orderState like '%'||#{keyWord}||'%'
	</select>

	<select id="orderPhotoInfo" resultType="String">
		select * from orderlist where purchaseSeq = 166;
	</select>
</mapper>